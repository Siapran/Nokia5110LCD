#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include <time.h>
#include <string.h>
#include "lcd/lcd.h"
#include "lcd/font.h"

#define FRAMES_PER_SECOND 30
#define BILLION 1000000000L

struct Timer
{
	struct timespec start, stop;
};

long get_msecs(struct timespec *start, struct timespec *end) {
	return (BILLION * (end->tv_sec - start->tv_sec) + end->tv_nsec - start->tv_nsec) / 1000000;
}

void timer_start(struct Timer *self) {
	clock_gettime(CLOCK_MONOTONIC, &self->start);
}

long timer_get_msecs(struct Timer *self) {
	clock_gettime(CLOCK_MONOTONIC, &self->stop);
	return get_msecs(&self->start, &self->stop);
}

static const char *days[] = {
	"Sunday",
	"Monday",
	"Tuesday",
	"Wednesday",
	"Thursday",
	"Friday",
	"Saturday"
};

static const char *months[] = {
	"January",
	"February",
	"March",
	"April",
	"May",
	"June",
	"July",
	"August",
	"September",
	"October",
	"November",
	"December"
};

static char date_string[512];

static const unsigned char numbers[] = {
	0xF0, 0xF0, 0xFC, 0xFC, 0x03, 0x03, 0x03, 0x03, 0x0F, 0x0F, 0xFC, 0xFC, 0xF0, 0xF0, 0x00, 0x00,
	0x03, 0x03, 0x0F, 0x0F, 0x3C, 0x3C, 0x30, 0x30, 0x30, 0x30, 0x0F, 0x0F, 0x03, 0x03, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x30, 0x30, 0x30, 0x30, 0x3F, 0x3F, 0x3F, 0x3F, 0x30, 0x30, 0x30, 0x30, 0x00, 0x00,
	0x0C, 0x0C, 0x0F, 0x0F, 0xC3, 0xC3, 0xC3, 0xC3, 0xF3, 0xF3, 0xFF, 0xFF, 0x3C, 0x3C, 0x00, 0x00,
	0x3C, 0x3C, 0x3F, 0x3F, 0x3F, 0x3F, 0x33, 0x33, 0x33, 0x33, 0x30, 0x30, 0x30, 0x30, 0x00, 0x00,
	0x00, 0x00, 0x03, 0x03, 0xC3, 0xC3, 0xF3, 0xF3, 0xFF, 0xFF, 0xCF, 0xCF, 0x03, 0x03, 0x00, 0x00,
	0x0C, 0x0C, 0x3C, 0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3F, 0x3F, 0x0F, 0x0F, 0x00, 0x00,
	0xC0, 0xC0, 0xF0, 0xF0, 0x3C, 0x3C, 0x0F, 0x0F, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00,
	0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x3F, 0x3F, 0x3F, 0x3F, 0x03, 0x03, 0x00, 0x00,
	0x3F, 0x3F, 0x3F, 0x3F, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0xF3, 0xF3, 0xC0, 0xC0, 0x00, 0x00,
	0x0C, 0x0C, 0x3C, 0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3F, 0x3F, 0x0F, 0x0F, 0x00, 0x00,
	0xF0, 0xF0, 0xFC, 0xFC, 0xCF, 0xCF, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0x00, 0x00, 0x00, 0x00,
	0x0F, 0x0F, 0x3F, 0x3F, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3F, 0x3F, 0x0F, 0x0F, 0x00, 0x00,
	0x0F, 0x0F, 0x0F, 0x0F, 0x03, 0x03, 0xC3, 0xC3, 0xF3, 0xF3, 0x3F, 0x3F, 0x0F, 0x0F, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x3F, 0x3F, 0x3F, 0x3F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x3C, 0x3C, 0xFF, 0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF, 0x3C, 0x3C, 0x00, 0x00,
	0x0F, 0x0F, 0x3F, 0x3F, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3F, 0x3F, 0x0F, 0x0F, 0x00, 0x00,
	0x3C, 0x3C, 0xFF, 0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF, 0xFC, 0xFC, 0x00, 0x00,
	0x00, 0x00, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3C, 0x3C, 0x0F, 0x0F, 0x03, 0x03, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x3C, 0x3C, 0x3C, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x3C, 0x3C, 0x3C, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

struct Banner
{
	char *string;
	int offset;
	int len;
};

void print_number(int number, int x, int y) {
	LCD_Blit(&numbers[number * 32], x, y, 16, 16, OR);
}

void draw_time(struct tm *current) {
	print_number(current->tm_hour / 10 % 10, 5, 16);
	print_number(current->tm_hour % 10, 21, 16);
	print_number(10, 35, 15);
	print_number(current->tm_min / 10 % 10, 47, 16);
	print_number(current->tm_min % 10, 63, 16);
}

void draw_clock_frame() {
	LCD_HorizontalLine(12, 2, 79, BLACK);
	LCD_HorizontalLine(33, 2, 80, BLACK);
	LCD_HorizontalLine(34, 3, 81, BLACK);
	LCD_HorizontalLine(35, 4, 81, BLACK);

	LCD_VerticalLine(1, 13, 32, BLACK);
	LCD_VerticalLine(80, 13, 32, BLACK);
	LCD_VerticalLine(81, 14, 33, BLACK);
	LCD_VerticalLine(82, 15, 34, BLACK);

	LCD_Pixel(2, 13, BLACK);
	LCD_Pixel(2, 32, BLACK);
	LCD_Pixel(79, 13, BLACK);
	LCD_Pixel(79, 32, BLACK);

}

void string_print_date(char *string, struct tm *current) {
	sprintf(string, "%s %d %s %d",
	        days[current->tm_wday],
	        current->tm_mday,
	        months[current->tm_mon],
	        1900 + current->tm_year);
}

void update_banner(struct Banner *banner) {
	banner->len = strlen(banner->string) + 1;
	banner->offset = (banner->offset - 1) % (banner->len * (LCD_CHAR_WIDTH + 1));
}

void draw_banner(struct Banner *banner, int y) {
	LCD_HorizontalLine(y, 0, LCD_WIDTH - 1, BLACK);
	LCD_HorizontalLine(y + 8, 0, LCD_WIDTH - 1, BLACK);
	LCD_HorizontalLine(y + 9, 0, LCD_WIDTH - 1, BLACK);

	LCD_TextLocate(banner->offset, y + 2);
	LCD_Text(banner->string);
	LCD_TextLocate(banner->offset + (banner->len * (LCD_CHAR_WIDTH + 1)), y + 2);
	LCD_Text(banner->string);
}

int main()
{
	struct Timer fps;
	
	time_t current;
	struct tm *current_tm;
	struct Banner date_banner = {
		.string = date_string,
		.offset = 0
	};

	if (LCD_Init() != 0) {
		printf("Error initializing LCD\n");
		return 1;
	}

	LCD_SetBacklight(1);

	for (;;) {

		timer_start(&fps);

		current = time(NULL);
		current_tm = localtime(&current);
		string_print_date(date_string, current_tm);

		LCD_Clear();
		draw_clock_frame();
		draw_time(current_tm);
		update_banner(&date_banner);
		draw_banner(&date_banner, 0);
		draw_banner(&date_banner, 38);
		LCD_Display();

		if (timer_get_msecs(&fps) < 1000 / FRAMES_PER_SECOND) {
			usleep(1000 * ( 1000 / FRAMES_PER_SECOND ) - timer_get_msecs(&fps));
		}

	}

	return 0;
}

